<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Patients List</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
  <style>
    body {
      background-color: #f8f9fa;
    }
    .patient-card {
      transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
      border-radius: 12px;
    }
    .patient-card:hover {
      transform: translateY(-5px);
      box-shadow: 0px 8px 20px rgba(0,0,0,0.15);
    }
    .card-title {
      font-weight: 600;
      font-size: 1.25rem;
      color: #0d6efd;
    }
    .card-text strong {
      color: #495057;
    }
  </style>
</head>
<body>
  
  <a href="../adminDashboard.html">
    <button class="btn btn-primary mx-3 my-3">Go back</button> 
  </a>
  <div class="container py-5">
    
    <h2 class="mb-4 text-center fw-bold">üë®‚Äç‚öïÔ∏è Patients List</h2>

    <!-- <input type="search" class="form-control" placeholder="search by username or email"> -->

    <div class="input-group shadow-sm rounded-3">
        <span class="input-group-text bg-white border-0">
        <i class="bi bi-search text-muted"></i>
        </span>
        <input 
        id="searchInput"
        type="search" 
        class="form-control border-0" 
        placeholder="Search by username or email" 
        aria-label="Search"

        onkeyup="filterUsers()"
        >
        <button class="btn btn-primary rounded-end-3">
        Search
        </button>
    </div>

    <br>
    <div id="patientsContainer" class="row g-4">
      <!-- Patient cards will be injected here -->
    </div>

    <nav>
      <ul id="pagination" class="pagination justify-content-center mt-4"></ul>
    </nav>
  </div>

  <script type="module">
    import { togglePatientLock,getAllPatients, requireAuth, searchPatient, handleAuthError } from "../../assets/api.js";

    requireAuth();

    const patientsContainer = document.getElementById("patientsContainer");
    const pagination = document.getElementById("pagination");

    let currentKeyword = "";
    let currentPage = 0;
    const pageSize = 10; // how many patients per page

    // Load patients (default: without search)
    async function loadPatients(page = 0) {
      try {
        const data = await getAllPatients(page, pageSize);
        renderPatients(data.content);
        renderPagination(data, false);
      } catch (error) {
        handleAuthError(error);
        patientsContainer.innerHTML = `<p class="text-danger">Error loading patients</p>`;
      }
    }

    // Search patients
    async function filterUsers(page = 0) {
      const keyword = document.getElementById("searchInput").value.trim();
      currentKeyword = keyword;

      if (keyword === "") {
        loadPatients(page);
        return;
      }

      try {
        const data = await searchPatient(keyword, page, pageSize);
        renderPatients(data.content);
        renderPagination(data, true);
      } catch (error) {
        handleAuthError(error);
        patientsContainer.innerHTML = `<p class="text-danger">Error searching patients</p>`;
      }
    }

    function renderPatients(patients) {
      patientsContainer.innerHTML = "";

      if (!patients || patients.length === 0) {
        patientsContainer.innerHTML = `<p class="text-muted text-center">No patients found.</p>`;
        return;
      }

      patients.forEach(patient => {
        const card = document.createElement("div");
        card.className = "col-md-4";
        card.innerHTML = `
          <div class="card patient-card shadow-sm h-100">
            <div class="card-body d-flex flex-column">
              <h5 class="card-title">${patient.fullName || "N/A"}</h5>
              <p class="card-text flex-grow-1">
                <strong>Email:</strong> ${patient.user?.email || "N/A"}<br>
                <strong>Phone:</strong> ${patient.phonenumber || "N/A"}<br>
                <strong>Gender:</strong> ${patient.gender || "N/A"}<br>
                <strong>DOB:</strong> ${patient.dob || "N/A"}<br>
                <strong>Address:</strong> ${patient.address || "N/A"}<br>
                <strong>Status:</strong> 
                  ${patient.user?.accountLocked 
                    ? '<span class="badge bg-danger">Locked</span>' 
                    : '<span class="badge bg-success">Active</span>'}
              </p>
              <button 
                class="btn ${patient.user?.accountLocked ? "btn-success" : "btn-danger"} mt-auto"
                onclick="toggleLock(${patient.user?.userId}, ${patient.user?.accountLocked})">
                ${patient.user?.accountLocked ? "Unlock" : "Lock"}
              </button>
            </div>
          </div>
        `;
        patientsContainer.appendChild(card);
      });
    }


    // Render patient cards
    // function renderPatients(patients) {
    //   patientsContainer.innerHTML = "";

    //   if (!patients || patients.length === 0) {
    //     patientsContainer.innerHTML = `<p class="text-muted text-center">No patients found.</p>`;
    //     return;
    //   }

    //   patients.forEach(patient => {
    //     const card = document.createElement("div");
    //     card.className = "col-md-4";
    //     card.innerHTML = `
    //       <div class="card patient-card shadow-sm h-100">
    //         <div class="card-body">
    //           <h5 class="card-title">${patient.fullName || "N/A"}</h5>
    //           <p class="card-text">
    //             <strong>Email:</strong> ${patient.user?.email || "N/A"}<br>
    //             <strong>Phone:</strong> ${patient.phonenumber || "N/A"}<br>
    //             <strong>Gender:</strong> ${patient.gender || "N/A"}<br>
    //             <strong>DOB:</strong> ${patient.dob || "N/A"}<br>
    //             <strong>Address:</strong> ${patient.address || "N/A"}
    //           </p>
    //         </div>
    //       </div>
    //     `;
    //     patientsContainer.appendChild(card);
    //   });
    // }

    // Render pagination controls
    function renderPagination(pageData, isSearch = false) {
      pagination.innerHTML = "";

      if (pageData.totalPages <= 1) return; // no pagination needed

      for (let i = 0; i < pageData.totalPages; i++) {
        const li = document.createElement("li");
        li.className = `page-item ${i === pageData.number ? "active" : ""}`;
        li.innerHTML = `<a class="page-link" href="#">${i + 1}</a>`;
        li.onclick = (e) => {
          e.preventDefault();
          if (isSearch) {
            filterUsers(i);
          } else {
            loadPatients(i);
          }
        };
        pagination.appendChild(li);
      }
    }

    async function toggleLock(userId, isLocked) {
      try {
        await togglePatientLock(userId);
        alert(`User ${isLocked ? "unlocked" : "locked"} successfully`);
        // reload current page
        if (currentKeyword) {
          filterUsers(currentPage);
        } else {
          loadPatients(currentPage);
        }
      } catch (error) {
        console.error("Error toggling lock", error);
        alert("Failed to update user status");
      }
    }
    window.toggleLock = toggleLock;
    // Expose search to window (so inline HTML works)
    window.filterUsers = filterUsers;

    // Initial load
    loadPatients();

  </script>
</body>
</html>

























<!-- import { getAllPatients, requireAuth, searchPatient, handleAuthError } from "../../assets/api.js";

    requireAuth();
    const patientsContainer = document.getElementById("patientsContainer");

    async function loadPatients() {
      try {
        const data = await getAllPatients(); // JSON response
        renderPatients(data.content);
      } catch (error) {
        handleAuthError(error);
        patientsContainer.innerHTML = `<p class="text-danger">Error loading patients</p>`;
      }
    }

    function renderPatients(patients) {
      patientsContainer.innerHTML = "";

      if (!patients || patients.length === 0) {
        patientsContainer.innerHTML = `<p class="text-muted text-center">No patients found.</p>`;
        return;
      }

      patients.forEach(patient => {
        const card = document.createElement("div");
        card.className = "col-md-4";
        card.innerHTML = `
          <div class="card patient-card shadow-sm h-100">
            <div class="card-body">
              <h5 class="card-title">${patient.fullName || "N/A"}</h5>
              <p class="card-text">
                <strong>Email:</strong> ${patient.user?.email || "N/A"}<br>
                <strong>Phone:</strong> ${patient.phonenumber || "N/A"}<br>
                <strong>Gender:</strong> ${patient.gender || "N/A"}<br>
                <strong>DOB:</strong> ${patient.dob || "N/A"}<br>
                <strong>Address:</strong> ${patient.address || "N/A"}
              </p>
            </div>
          </div>
        `;
        patientsContainer.appendChild(card);
      });
    }


    async function filterUsers() {
      const keyword = document.getElementById("searchInput").value.trim();

      if (keyword === "") {
        loadPatients();
        return;
      }

      try {
        const data = await searchPatient(keyword, 0, 20);
        renderPatients(data.content);
      } catch (error) {
        handleAuthError(error);
        patientsContainer.innerHTML = `<p class="text-danger">Error searching patients</p>`;
      }
    }
    window.filterUsers = filterUsers;

    loadPatients(); -->