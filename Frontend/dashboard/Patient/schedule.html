<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Doctor Slots</title>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
  <a href="doctorDetailsBooking.html">
    <button class="btn btn-primary mx-3 my-3">Go back</button>
  </a>
  <div class="container py-5">
    <h2 class="mb-4 text-center fw-bold">ðŸ“… Choose a Slot</h2>
    <div id="slotsContainer"></div>
  </div>

  <script type="module">
    import { getDoctorSlotsForPatient, createAppointment, createPaymentOrder } from "../../assets/api.js";

    const urlParams = new URLSearchParams(window.location.search);
    const doctorId = urlParams.get("doctorId");

    const slotsContainer = document.getElementById("slotsContainer");

    async function loadDoctorSlots() {
      try {
        const slots = await getDoctorSlotsForPatient(doctorId);

        if (!slots || slots.length === 0) {
          slotsContainer.innerHTML = `<p class="text-muted">No slots available.</p>`;
          return;
        }

        // Group slots by date
        const slotsByDate = {};
        slots.forEach(slot => {
          if (!slotsByDate[slot.date]) slotsByDate[slot.date] = [];
          slotsByDate[slot.date].push(slot);
        });

        slotsContainer.innerHTML = "";
        for (const [date, slotList] of Object.entries(slotsByDate)) {
          const dateSection = document.createElement("div");
          dateSection.className = "mb-4";
          dateSection.innerHTML = `<h5 class="fw-bold">${date}</h5>`;

          slotList.forEach(s => {
            const btn = document.createElement("button");
            btn.className = "btn btn-outline-primary m-1";
            btn.innerText = `${s.startTime} - ${s.endTime}`;
            btn.onclick = () => bookSlot(doctorId, s.slotId);
            dateSection.appendChild(btn);
          });

          slotsContainer.appendChild(dateSection);
        }
      } catch (error) {
        console.error(error);
        slotsContainer.innerHTML = `<p class="text-danger">Error loading slots</p>`;
      }
    }

    async function bookSlot(doctorId, slotId) {
      if (!confirm("Confirm booking this slot?")) return;

      try {
        // Step 1: create appointment (PENDING)
        const booking = await createAppointment(doctorId, slotId);
        console.log("Appointment created:", booking);

        // Step 2: request payment order from backend
        const order = await createPaymentOrder(booking.appointmentId);
        console.log("Payment order:", order);

        // Step 3: launch Razorpay
        const options = {
          key: "rzp_test_R9qbDrcsXCHB62", // ðŸ”‘ replace with your Razorpay test key
          amount: order.amount,
          currency: order.currency,
          name: "Healix",
          description: "Doctor Appointment Payment",
          order_id: order.id,
          handler: function (response) {
            console.log("Payment success:", response);
            Swal.fire({
              icon: "success",
              title: "Payment Successful ðŸŽ‰",
              text: "Your appointment has been confirmed.",
              confirmButtonColor: "#0d6efd"
            });
          },
          prefill: {
            name: booking.patient.fullName,
            email: booking.patient.user?.email,
            contact: booking.patient.phonenumber
          },
          theme: { color: "#0d6efd" }
        };
        console.log("name :",booking.patient.fullName);
        console.log("email :",booking.patient.user?.email);
        console.log("number :",booking.patient.phonenumber);
        

        const rzp = new Razorpay(options);
        rzp.open();
      } catch (error) {
        console.error("Booking/payment failed", error);
        Swal.fire({
          icon: "error",
          title: "Failed",
          text: "Could not book or pay for appointment: " + error.message,
          confirmButtonColor: "#dc3545"
        });
      }
    }

    loadDoctorSlots();
  </script>
</body>
</html>
